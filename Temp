import os
from openai import OpenAI
import json

client = OpenAI()

def load_json_context(json_names: list, base_dir: str = "../input_data/67648643"):
    context = {}
    for name in json_names:
        file_path = os.path.join(base_dir, f"{name}.json")
        with open(file_path, "r", encoding="utf-8") as f:
            context[name] = f.read()
    return context

def process_user_query(query: str, system_prompt: str):
    messages = [
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": query}
    ]

    result = client.chat.completions.create(
        model="gpt-4o-openai",
        messages=messages,
        temperature=0
    )

    reply = result.choices[0].message.content.strip()

    try:
        # Try to parse reply as JSON list
        json_list = json.loads(reply)
        if isinstance(json_list, list):
            print("Loading content for JSONs:", json_list)
            return load_json_context(json_list)
        else:
            print("Unexpected format (not a list), response:", reply)
            return {"response": reply}
    except json.JSONDecodeError:
        print("No relevant JSONs, casual query response:")
        return {"response": reply}
