import tiktoken

def count_tokens(messages, model="gpt-4"):
    # Get the appropriate encoding for the model
    try:
        encoding = tiktoken.encoding_for_model(model)
    except KeyError:
        encoding = tiktoken.get_encoding("cl100k_base")

    # Set tokens per message based on the model
    if model == "gpt-3.5-turbo":
        tokens_per_message = 4
        tokens_per_name = -1
    elif model == "gpt-4":
        tokens_per_message = 3
        tokens_per_name = 1
    else:
        raise ValueError(f"Model '{model}' not supported.")

    total_tokens = 0
    for msg in messages:
        total_tokens += tokens_per_message
        for key, value in msg.items():
            total_tokens += len(encoding.encode(value))
            if key == "name":
                total_tokens += tokens_per_name

    # Add tokens required for priming
    total_tokens += 3
    return total_tokens

# Example usage:
if __name__ == "__main__":
    messages = [
        {"role": "system", "content": "You're a helpful medical assistant."},
        {"role": "user", "content": "What are my latest medications?"},
        {"role": "assistant", "content": "Your latest medications include Aspirin and Metformin."}
    ]

    total = count_tokens(messages, model="gpt-4")
    print(f"Total tokens used: {total}")
